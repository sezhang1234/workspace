import React, { useState, useEffect } from 'react'
import { useNavigate, useLocation, useParams } from 'react-router-dom'
import { 
  ArrowLeft, 
  Save, 
  Play, 
  TestTube,
  Copy,
  Download,
  Upload,
  Trash2,
  Brain,
  Settings,
  Eye,
  Sparkles,
  Zap,
  BookOpen,
  MessageSquare,
  Plug
} from 'lucide-react'
import { 
  TextField, 
  Button, 
  Select, 
  MenuItem, 
  FormControl, 
  InputLabel, 
  Switch, 
  FormControlLabel,
  Chip,
  Tabs,
  Tab,
  Box,
  Typography,
  Card,
  Alert,
  Snackbar,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Divider,
  Paper
} from '@mui/material'

interface TabPanelProps {
  children?: React.ReactNode
  index: number
  value: number
}

interface AgentEntryData {
  editMode: 'manual' | 'ai'
  name: string
  description: string
  icon: string
}

interface AgentConfig {
  name: string
  description: string
  icon: string
  editMode: 'manual' | 'ai'
  
  // System Prompt Configuration
  systemPrompt: string
  autoGeneratedPrompt: string
  promptTuning: {
    inputMode: 'upload' | 'manual'
    examples: string
    useCases: Array<{
      id: number
      name: string
      data: any
      uploadTime: Date
    }>
    optimizationModel: string
    evaluationModel: string
    optimizationRounds: number
  }
  
  // Orchestration Configuration
  model: string
  modelParams: {
    temperature: number
    maxTokens: number
    topP: number
    frequencyPenalty: number
    presencePenalty: number
  }
  plugins: string[]
  workflows: string[]
  triggers: string[]
  knowledge: string[]
  memory: {
    enabled: boolean
    type: 'conversation' | 'semantic' | 'hybrid'
    maxTokens: number
  }
  openingRemarks: string
  
  // Preview and Debug
  testHistory: Array<{ role: 'user' | 'assistant', content: string, timestamp: Date }>
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props

  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`agent-tabpanel-${index}`}
      aria-labelledby={`agent-tab-${index}`}
      {...other}
    >
      {value === index && (
        <Box sx={{ p: 4 }}>
          {children}
        </Box>
      )}
    </div>
  )
}

const AgentEditorEnhancedPage: React.FC = () => {
  const navigate = useNavigate()
  const location = useLocation()
  const { id } = useParams()
  
  const [activeTab, setActiveTab] = useState(0)
  const [snackbar, setSnackbar] = useState({ open: false, message: '', severity: 'success' as 'success' | 'error' })
  
  // Get entry data from navigation state (for new agents) or determine if editing existing agent
  const entryData = location.state?.agentEntryData as AgentEntryData | undefined
  const isNew = !id || id === 'new'
  const isEditing = !isNew

  // Agent configuration state
  const [agentConfig, setAgentConfig] = useState<AgentConfig>({
    name: entryData?.name || 'æ™ºèƒ½å®¢æœåŠ©æ‰‹',
    description: entryData?.description || 'ä¸“ä¸šçš„å®¢æˆ·æœåŠ¡æ™ºèƒ½ä½“ï¼Œèƒ½å¤Ÿå¤„ç†å¸¸è§é—®é¢˜å’ŒæŠ•è¯‰',
    icon: entryData?.icon || 'ğŸ¤–',
    editMode: entryData?.editMode || 'manual',
    
    // System Prompt Configuration
    systemPrompt: entryData?.editMode === 'ai' ? 
      `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„${entryData?.name || 'æ™ºèƒ½åŠ©æ‰‹'}ï¼Œ${entryData?.description || ''}ã€‚è¯·å§‹ç»ˆä¿æŒå‹å¥½ã€ä¸“ä¸šçš„æ€åº¦ï¼Œæä¾›å‡†ç¡®ã€æœ‰ç”¨çš„å¸®åŠ©ã€‚` :
      'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æˆ·æœåŠ¡ä»£è¡¨ï¼Œè¯·ç”¨å‹å¥½ã€ä¸“ä¸šçš„æ€åº¦å›ç­”å®¢æˆ·é—®é¢˜ã€‚',
    autoGeneratedPrompt: '',
    promptTuning: {
      inputMode: 'manual',
      examples: 'ç”¨æˆ·ï¼šä½ å¥½\nåŠ©æ‰‹ï¼šæ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
      useCases: [
        {
          id: 1,
          name: 'customer_service_examples.json',
          data: [
            { user: 'ä½ å¥½', assistant: 'æ‚¨å¥½ï¼æˆ‘æ˜¯å®¢æœåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ' },
            { user: 'æˆ‘æƒ³é€€è´§', assistant: 'å¥½çš„ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨çš„è®¢å•å·å’Œé€€è´§åŸå› ï¼Œæˆ‘æ¥å¸®æ‚¨å¤„ç†ã€‚' }
          ],
          uploadTime: new Date('2024-01-15T10:30:00'),
          status: 'active',
          examples: 2
        },
        {
          id: 2,
          name: 'technical_support.csv',
          data: [
            { user: 'ç³»ç»Ÿæ— æ³•ç™»å½•', assistant: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œè´¦å·å¯†ç æ˜¯å¦æ­£ç¡®ã€‚' },
            { user: 'é¡µé¢æ˜¾ç¤ºé”™è¯¯', assistant: 'è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€‚' }
          ],
          uploadTime: new Date('2024-01-14T14:20:00'),
          status: 'active',
          examples: 2
        },
        {
          id: 3,
          name: 'product_qa.txt',
          data: 'ç”¨æˆ·ï¼šè¿™ä¸ªäº§å“æ€ä¹ˆç”¨ï¼Ÿ\nåŠ©æ‰‹ï¼šè¯·å‚è€ƒäº§å“è¯´æ˜ä¹¦ï¼Œå¦‚æœ‰ç–‘é—®å¯è”ç³»å®¢æœã€‚',
          uploadTime: new Date('2024-01-13T09:15:00'),
          status: 'active',
          examples: 1
        }
      ],
      optimizationModel: 'gpt-4',
      evaluationModel: 'gpt-4',
      optimizationRounds: 3
    },
    
    // Orchestration Configuration
    model: 'gpt-4',
    modelParams: {
      temperature: 0.7,
      maxTokens: 2000,
      topP: 0.9,
      frequencyPenalty: 0.0,
      presencePenalty: 0.0
    },
    plugins: ['web_search', 'calculator', 'file_reader'],
    workflows: ['customer_service', 'troubleshooting'],
    triggers: ['greeting', 'question', 'complaint'],
    knowledge: ['product_manual', 'faq_database', 'company_policies'],
    memory: {
      enabled: true,
      type: 'conversation',
      maxTokens: 1000
    },
    openingRemarks: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
    
    // Preview and Debug
    testHistory: []
  })

  // Test chat state
  const [testMessage, setTestMessage] = useState('')
  const [isTesting, setIsTesting] = useState(false)

  useEffect(() => {
    if (entryData?.editMode === 'ai') {
      // Auto-generate system prompt for AI mode
      const generatedPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„${entryData.name}ï¼Œ${entryData.description}ã€‚

è§’è‰²å®šä¹‰ï¼š
- ä¸»è¦èŒè´£ï¼š${entryData.description}
- è¡Œä¸ºå‡†åˆ™ï¼šå§‹ç»ˆä¿æŒå‹å¥½ã€ä¸“ä¸šã€å‡†ç¡®
- å“åº”é£æ ¼ï¼šæ¸…æ™°ã€æœ‰ç”¨ã€åŠæ—¶

èƒ½åŠ›èŒƒå›´ï¼š
- é—®é¢˜è§£ç­”ï¼šèƒ½å¤Ÿç†è§£å¹¶å›ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜
- ä»»åŠ¡ååŠ©ï¼šå¸®åŠ©ç”¨æˆ·å®Œæˆç›¸å…³ä»»åŠ¡
- ä¿¡æ¯æŸ¥è¯¢ï¼šæä¾›å‡†ç¡®çš„ä¿¡æ¯å’Œå»ºè®®

ç¤ºä¾‹å¯¹è¯ï¼š
ç”¨æˆ·ï¼šä½ å¥½
åŠ©æ‰‹ï¼šæ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ

è¯·æ ¹æ®ä»¥ä¸Šé…ç½®ï¼Œä¸ºç”¨æˆ·æä¾›æœ€å¥½çš„æœåŠ¡ä½“éªŒã€‚`

      setAgentConfig(prev => ({
        ...prev,
        autoGeneratedPrompt: generatedPrompt,
        systemPrompt: generatedPrompt
      }))
    }
  }, [entryData])

  const handleTabChange = (_event: React.SyntheticEvent, newValue: number) => {
    setActiveTab(newValue)
  }

  const handleSave = () => {
    // Simulate saving
    setSnackbar({ open: true, message: 'æ™ºèƒ½ä½“é…ç½®ä¿å­˜æˆåŠŸï¼', severity: 'success' })
  }

  const handleTest = async () => {
    if (!testMessage.trim()) return
    
    setIsTesting(true)
    const userMessage = { 
      role: 'user' as const, 
      content: testMessage,
      timestamp: new Date()
    }
    
    setAgentConfig(prev => ({
      ...prev,
      testHistory: [...prev.testHistory, userMessage]
    }))
    
    // Simulate AI response
    setTimeout(() => {
      const aiResponse = { 
        role: 'assistant' as const, 
        content: `è¿™æ˜¯å¯¹"${testMessage}"çš„æ¨¡æ‹Ÿå›å¤ã€‚åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨é…ç½®çš„LLM APIå¹¶æ ¹æ®ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆå“åº”ã€‚`,
        timestamp: new Date()
      }
      
      setAgentConfig(prev => ({
        ...prev,
        testHistory: [...prev.testHistory, aiResponse]
      }))
      setIsTesting(false)
    }, 1000)
    
    setTestMessage('')
  }



  const handleExport = () => {
    const dataStr = JSON.stringify(agentConfig, null, 2)
    const dataBlob = new Blob([dataStr], { type: 'application/json' })
    const url = URL.createObjectURL(dataBlob)
    const link = document.createElement('a')
    link.href = url
    link.download = `${agentConfig.name || 'agent'}.json`
    link.click()
    URL.revokeObjectURL(url)
  }

  const handleImport = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      const reader = new FileReader()
      reader.onload = (e) => {
        try {
          const importedConfig = JSON.parse(e.target?.result as string)
          setAgentConfig(importedConfig)
          setSnackbar({ open: true, message: 'æ™ºèƒ½ä½“é…ç½®å¯¼å…¥æˆåŠŸ', severity: 'success' })
        } catch (error) {
          setSnackbar({ open: true, message: 'å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯', severity: 'error' })
        }
      }
      reader.readAsText(file)
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50">
      <div className="max-w-7xl mx-auto px-6 py-8">
        {/* Page header */}
        <div className="mb-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-6">
              <Button
                variant="outlined"
                startIcon={<ArrowLeft />}
                onClick={() => navigate('/dashboard/agents')}
                className="border-gray-300 text-gray-600 hover:border-gray-400 hover:bg-gray-50"
              >
                è¿”å›
              </Button>
              <div className="flex items-center space-x-4">
                <span className="text-4xl">{agentConfig.icon}</span>
                                <div>
                  <h1 className="text-3xl font-bold text-gray-900">
                    {isNew ? 'åˆ›å»ºæ™ºèƒ½ä½“' : 'ç¼–è¾‘æ™ºèƒ½ä½“'}
                  </h1>
                  <p className="text-lg text-gray-600">
                    {isNew ? 'é…ç½®æ™ºèƒ½ä½“çš„ç³»ç»Ÿæç¤ºè¯ã€ç¼–æ’å‚æ•°å’Œè°ƒè¯•ä¿¡æ¯' : 'ä¿®æ”¹æ™ºèƒ½ä½“é…ç½®å’Œå‚æ•°'}
                  </p>
                  <p className="text-sm text-gray-500 mt-1">
                    {agentConfig.description}
                  </p>
                </div>
              </div>
            </div>
            
            <div className="flex items-center space-x-4">
              <Button
                variant="outlined"
                startIcon={<TestTube />}
                onClick={() => setActiveTab(2)}
                className="border-blue-300 text-blue-600 hover:border-blue-400 hover:bg-blue-50"
              >
                æµ‹è¯•è°ƒè¯•
              </Button>
              <Button
                variant="contained"
                startIcon={<Save />}
                onClick={handleSave}
                className="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-lg"
              >
                ä¿å­˜é…ç½®
              </Button>
            </div>
          </div>
        </div>

        {/* Main content */}
        <Card className="shadow-xl border-0 overflow-hidden">
          <Box sx={{ borderBottom: 1, borderColor: 'divider', backgroundColor: 'white' }}>
            <Tabs 
              value={activeTab} 
              onChange={handleTabChange} 
              aria-label="æ™ºèƒ½ä½“é…ç½®æ ‡ç­¾é¡µ"
              className="px-6"
              sx={{
                '& .MuiTab-root': {
                  minHeight: '64px',
                  fontSize: '1rem',
                  fontWeight: 500,
                  textTransform: 'none',
                  color: '#6B7280',
                  '&.Mui-selected': {
                    color: '#3B82F6',
                    fontWeight: 600,
                  },
                },
                '& .MuiTabs-indicator': {
                  height: '3px',
                  borderRadius: '2px',
                  backgroundColor: '#3B82F6',
                },
              }}
            >
              <Tab 
                label={
                  <div className="flex items-center space-x-3">
                    <Brain className="w-5 h-5" />
                    <span>ç³»ç»Ÿæç¤ºè¯é…ç½®</span>
                  </div>
                } 
              />
              <Tab 
                label={
                  <div className="flex items-center space-x-3">
                    <Settings className="w-5 h-5" />
                    <span>ç¼–æ’é…ç½®</span>
                  </div>
                } 
              />
              <Tab 
                label={
                  <div className="flex items-center space-x-3">
                    <Eye className="w-5 h-5" />
                    <span>é¢„è§ˆè°ƒè¯•</span>
                  </div>
                } 
              />
            </Tabs>
          </Box>

          {/* System Prompt Configuration Tab */}
          <TabPanel value={activeTab} index={0}>
            <div className="space-y-8">
              <div className="flex items-center justify-between">
                <Typography variant="h6" className="text-gray-800 font-semibold">
                  ç³»ç»Ÿæç¤ºè¯å¼€å‘
                </Typography>
              </div>
              
                              <Paper elevation={0} className="p-6 border border-gray-200 rounded-xl">
                  <Typography variant="subtitle1" className="mb-4 text-gray-700 font-medium">
                    ç³»ç»Ÿæç¤ºè¯
                  </Typography>
                  <TextField
                    fullWidth
                    multiline
                    rows={8}
                    value={agentConfig.systemPrompt}
                    onChange={(e) => setAgentConfig(prev => ({ ...prev, systemPrompt: e.target.value }))}
                    placeholder="å®šä¹‰æ™ºèƒ½ä½“çš„è§’è‰²ã€èƒ½åŠ›å’Œè¡Œä¸ºå‡†åˆ™..."
                    className="mt-2"
                  />
                  <div className="mt-6">
                    <Button
                      variant="contained"
                      startIcon={<Sparkles />}
                      onClick={() => {
                        // Auto-generate prompt based on current configuration
                        const generatedPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ™ºèƒ½åŠ©æ‰‹ï¼Œ${agentConfig.description}ã€‚

è§’è‰²å®šä¹‰ï¼š
- ä¸»è¦èŒè´£ï¼šæ™ºèƒ½åŠ©æ‰‹
- è¡Œä¸ºå‡†åˆ™ï¼šå‹å¥½ã€ä¸“ä¸šã€å‡†ç¡®
- å“åº”é£æ ¼ï¼šæ¸…æ™°ã€æœ‰ç”¨ã€åŠæ—¶

èƒ½åŠ›èŒƒå›´ï¼š
- é—®é¢˜è§£ç­”ï¼šèƒ½å¤Ÿç†è§£å¹¶å›ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜
- ä»»åŠ¡ååŠ©ï¼šå¸®åŠ©ç”¨æˆ·å®Œæˆç›¸å…³ä»»åŠ¡
- ä¿¡æ¯æŸ¥è¯¢ï¼šæä¾›å‡†ç¡®çš„ä¿¡æ¯å’Œå»ºè®®

ç¤ºä¾‹å¯¹è¯ï¼š
${agentConfig.promptTuning.examples || 'ç”¨æˆ·ï¼šä½ å¥½\nåŠ©æ‰‹ï¼šæ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ'}

è¯·æ ¹æ®ä»¥ä¸Šé…ç½®ï¼Œä¸ºç”¨æˆ·æä¾›æœ€å¥½çš„æœåŠ¡ä½“éªŒã€‚`

                        setAgentConfig(prev => ({
                          ...prev,
                          systemPrompt: generatedPrompt,
                          autoGeneratedPrompt: generatedPrompt
                        }))
                        setSnackbar({ open: true, message: 'ç³»ç»Ÿæç¤ºè¯è‡ªåŠ¨ç”ŸæˆæˆåŠŸï¼', severity: 'success' })
                      }}
                      className="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700"
                    >
                      è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯
                    </Button>
                  </div>
                </Paper>

              {agentConfig.editMode === 'ai' && (
                <Alert severity="info" icon={<Sparkles className="w-6 h-6" />} className="border border-blue-200 bg-blue-50">
                  <Typography variant="body1" className="text-blue-800">
                    <strong>æç¤ºè¯è‡ªåŠ¨ç”Ÿæˆï¼š</strong>
                    ç³»ç»Ÿå·²æ ¹æ®æ‚¨çš„æè¿°è‡ªåŠ¨ç”Ÿæˆäº†ç³»ç»Ÿæç¤ºè¯ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚
                  </Typography>
                </Alert>
              )}

              <Divider className="my-8" />

              {/* Prompt Tuning Section */}
              <div>
                <div className="mb-6">
                  <Typography variant="h6" className="text-gray-800 font-semibold">
                    æç¤ºè¯è°ƒä¼˜
                  </Typography>
                </div>
                
                {/* Dataset Configuration */}
                <Paper elevation={0} className="p-6 border border-gray-200 rounded-xl mb-6">
                  <Typography variant="subtitle1" className="mb-4 text-gray-700 font-medium">
                    æ•°æ®é›†é…ç½®
                  </Typography>
                  
                  {/* Toggle between Upload and Manual Input */}
                  <div className="mb-6">
                    <div className="flex items-center space-x-4 mb-4">
                      <FormControlLabel
                        control={
                          <Switch
                            checked={agentConfig.promptTuning.inputMode === 'upload'}
                            onChange={(e) => setAgentConfig(prev => ({
                              ...prev,
                              promptTuning: {
                                ...prev.promptTuning,
                                inputMode: e.target.checked ? 'upload' : 'manual'
                              }
                            }))}
                            color="primary"
                          />
                        }
                        label={
                          <Typography variant="subtitle2" className="text-gray-700 font-medium">
                            ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ 
                          </Typography>
                        }
                      />
                      <Typography variant="body2" className="text-gray-500">
                        {agentConfig.promptTuning.inputMode === 'upload' ? 'æ–‡ä»¶ä¸Šä¼ æ¨¡å¼' : 'æ‰‹åŠ¨è¾“å…¥æ¨¡å¼'}
                      </Typography>
                    </div>
                  </div>

                  {/* File Upload Mode */}
                  {agentConfig.promptTuning.inputMode === 'upload' && (
                    <div>
                      {/* Upload Header Row */}
                      <div className="flex items-center justify-between mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div className="flex items-center space-x-3">
                          <Typography variant="subtitle1" className="text-gray-800 font-medium">
                            å¯¼å…¥ç”¨ä¾‹é›†
                          </Typography>
                          <Typography variant="body2" className="text-gray-500">
                            æ”¯æŒ JSONã€CSVã€TXT æ ¼å¼æ–‡ä»¶
                          </Typography>
                        </div>
                        <div className="flex items-center space-x-3">
                          <input
                            type="file"
                            accept=".json,.csv,.txt"
                            onChange={(e) => {
                              const file = e.target.files?.[0]
                              if (file) {
                                const reader = new FileReader()
                                reader.onload = (event) => {
                                  try {
                                    const content = event.target?.result as string
                                    // Parse content based on file type
                                    let parsedData
                                    if (file.name.endsWith('.json')) {
                                      parsedData = JSON.parse(content)
                                    } else if (file.name.endsWith('.csv')) {
                                      // Simple CSV parsing
                                      const lines = content.split('\n')
                                      const headers = lines[0].split(',')
                                      parsedData = lines.slice(1).map(line => {
                                        const values = line.split(',')
                                        return headers.reduce((obj, header, index) => {
                                          obj[header.trim()] = values[index]?.trim() || ''
                                          return obj
                                        }, {} as any)
                                      })
                                    } else {
                                      // Text file - treat as plain text
                                      parsedData = content
                                    }
                                    
                                    setAgentConfig(prev => ({
                                      ...prev,
                                      promptTuning: {
                                        ...prev.promptTuning,
                                        useCases: [...(prev.promptTuning.useCases || []), {
                                          id: Date.now(),
                                          name: file.name,
                                          data: parsedData,
                                          uploadTime: new Date(),
                                          status: 'active',
                                          examples: parsedData.length || 1
                                        }]
                                      }
                                    }))
                                    setSnackbar({ open: true, message: 'ç”¨ä¾‹é›†ä¸Šä¼ æˆåŠŸï¼', severity: 'success' })
                                  } catch (error) {
                                    setSnackbar({ open: true, message: 'æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', severity: 'error' })
                                  }
                                }
                                reader.readAsText(file)
                              }
                            }}
                            className="hidden"
                            id="use-case-upload"
                          />
                          <label htmlFor="use-case-upload">
                            <IconButton
                              component="span"
                              className="p-2 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full transition-all duration-200"
                            >
                              <Upload className="w-5 h-5" />
                            </IconButton>
                          </label>
                          <IconButton
                            className="p-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-full transition-all duration-200"
                            onClick={() => {
                              setAgentConfig(prev => ({
                                ...prev,
                                promptTuning: {
                                  ...prev.promptTuning,
                                  useCases: []
                                }
                              }))
                              setSnackbar({ open: true, message: 'æ‰€æœ‰ç”¨ä¾‹é›†å·²æ¸…ç©º', severity: 'success' })
                            }}
                          >
                            <Trash2 className="w-5 h-5" />
                          </IconButton>
                        </div>
                      </div>

                      {/* Use Cases Table */}
                      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç”¨ä¾‹é›†åç§°
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                æ–‡ä»¶ç±»å‹
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ç¤ºä¾‹æ•°é‡
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ä¸Šä¼ æ—¶é—´
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                çŠ¶æ€
                              </th>
                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                æ“ä½œ
                              </th>
                            </tr>
                          </thead>
                          <tbody className="bg-white divide-y divide-gray-200">
                            {agentConfig.promptTuning.useCases && agentConfig.promptTuning.useCases.length > 0 ? (
                              agentConfig.promptTuning.useCases.map((useCase) => (
                                <tr key={useCase.id} className="hover:bg-gray-50">
                                  <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="flex items-center">
                                      <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <span className="text-blue-600 text-sm font-medium">
                                          {useCase.name.split('.').pop()?.toUpperCase()}
                                        </span>
                                      </div>
                                      <div className="text-sm font-medium text-gray-900">
                                        {useCase.name}
                                      </div>
                                    </div>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap">
                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                      {useCase.name.split('.').pop()?.toUpperCase()}
                                    </span>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {useCase.examples || 1}
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {useCase.uploadTime.toLocaleString()}
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap">
                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                      {useCase.status === 'active' ? 'æ´»è·ƒ' : 'å·²åœç”¨'}
                                    </span>
                                  </td>
                                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div className="flex items-center space-x-2">
                                      <IconButton
                                        size="small"
                                        className="p-1 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded"
                                        onClick={() => {
                                          // Mock edit functionality
                                          setSnackbar({ open: true, message: 'ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', severity: 'info' })
                                        }}
                                      >
                                        <Edit3 className="w-4 h-4" />
                                      </IconButton>
                                      <IconButton
                                        size="small"
                                        className="p-1 bg-red-100 hover:bg-red-200 text-red-600 rounded"
                                        onClick={() => {
                                          setAgentConfig(prev => ({
                                            ...prev,
                                            promptTuning: {
                                              ...prev.promptTuning,
                                              useCases: prev.promptTuning.useCases?.filter(uc => uc.id !== useCase.id) || []
                                            }
                                          }))
                                          setSnackbar({ open: true, message: 'ç”¨ä¾‹é›†å·²åˆ é™¤', severity: 'success' })
                                        }}
                                      >
                                        <Trash2 className="w-4 h-4" />
                                      </IconButton>
                                    </div>
                                  </td>
                                </tr>
                              ))
                            ) : (
                              <tr>
                                <td colSpan={6} className="px-6 py-12 text-center">
                                  <div className="flex flex-col items-center space-y-3">
                                    <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                                      <Upload className="w-6 h-6 text-gray-400" />
                                    </div>
                                    <div>
                                      <Typography variant="body1" className="text-gray-500 font-medium">
                                        æš‚æ— ç”¨ä¾‹é›†
                                      </Typography>
                                      <Typography variant="body2" className="text-gray-400">
                                        ç‚¹å‡»ä¸Šæ–¹ä¸Šä¼ å›¾æ ‡æ·»åŠ ç”¨ä¾‹é›†
                                      </Typography>
                                    </div>
                                  </div>
                                </td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {/* Manual Input Mode */}
                  {agentConfig.promptTuning.inputMode === 'manual' && (
                    <div>
                      <Typography variant="subtitle2" className="mb-3 text-gray-700 font-medium">
                        æ‰‹åŠ¨è¾“å…¥ç¤ºä¾‹å¯¹è¯
                      </Typography>
                      <TextField
                        fullWidth
                        multiline
                        rows={6}
                        value={agentConfig.promptTuning.examples}
                        onChange={(e) => setAgentConfig(prev => ({
                          ...prev,
                          promptTuning: { ...prev.promptTuning, examples: e.target.value }
                        }))}
                        placeholder="æä¾›ä¸€äº›ç¤ºä¾‹å¯¹è¯æ¥æŒ‡å¯¼æ™ºèƒ½ä½“çš„å“åº”æ¨¡å¼..."
                        className="mt-2"
                      />
                      <Typography variant="body2" className="text-gray-500 mt-2">
                        è¯·è¾“å…¥ç”¨æˆ·å’ŒåŠ©æ‰‹çš„å¯¹è¯ç¤ºä¾‹ï¼Œæ¯è¡Œä¸€ä¸ªå¯¹è¯è½®æ¬¡
                      </Typography>
                    </div>
                  )}
                </Paper>

                {/* Optimization Strategy */}
                <Paper elevation={0} className="p-6 border border-gray-200 rounded-xl">
                  <Typography variant="subtitle1" className="mb-4 text-gray-700 font-medium">
                    ä¼˜åŒ–ç­–ç•¥
                  </Typography>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <FormControl fullWidth>
                      <Typography variant="subtitle2" className="mb-3 text-gray-700 font-medium">
                        ä¼˜åŒ–æ¨¡å‹
                      </Typography>
                      <Select
                        value={agentConfig.promptTuning.optimizationModel || 'gpt-4'}
                        onChange={(e) => setAgentConfig(prev => ({
                          ...prev,
                          promptTuning: { 
                            ...prev.promptTuning, 
                            optimizationModel: e.target.value 
                          }
                        }))}
                        className="mt-2"
                      >
                        <MenuItem value="gpt-4">GPT-4</MenuItem>
                        <MenuItem value="gpt-3.5-turbo">GPT-3.5 Turbo</MenuItem>
                        <MenuItem value="claude-3">Claude-3</MenuItem>
                        <MenuItem value="gemini-pro">Gemini Pro</MenuItem>
                        <MenuItem value="qwen-plus">Qwen Plus</MenuItem>
                      </Select>
                    </FormControl>

                    <FormControl fullWidth>
                      <Typography variant="subtitle2" className="mb-3 text-gray-700 font-medium">
                        ç®—æ³•è¯„ä¼°æ¨¡å‹
                      </Typography>
                      <Select
                        value={agentConfig.promptTuning.evaluationModel || 'gpt-4'}
                        onChange={(e) => setAgentConfig(prev => ({
                          ...prev,
                          promptTuning: { 
                            ...prev.promptTuning, 
                            evaluationModel: e.target.value 
                          }
                        }))}
                        className="mt-2"
                      >
                        <MenuItem value="gpt-4">GPT-4</MenuItem>
                        <MenuItem value="gpt-3.5-turbo">GPT-3.5 Turbo</MenuItem>
                        <MenuItem value="claude-3">Claude-3</MenuItem>
                        <MenuItem value="gemini-pro">Gemini Pro</MenuItem>
                        <MenuItem value="qwen-plus">Qwen Plus</MenuItem>
                      </Select>
                    </FormControl>

                    <FormControl fullWidth>
                      <Typography variant="subtitle2" className="mb-3 text-gray-700 font-medium">
                        ä¼˜åŒ–è½®æ•°
                      </Typography>
                      <TextField
                        fullWidth
                        type="number"
                        value={agentConfig.promptTuning.optimizationRounds || 3}
                        onChange={(e) => setAgentConfig(prev => ({
                          ...prev,
                          promptTuning: { 
                            ...prev.promptTuning, 
                            optimizationRounds: parseInt(e.target.value) 
                          }
                        }))}
                        inputProps={{ min: 1, max: 10, step: 1 }}
                        helperText="å»ºè®®è®¾ç½® 3-5 è½®"
                        className="mt-2"
                      />
                    </FormControl>


                  </div>

                  <div className="mt-6">
                    <Button
                      variant="contained"
                      startIcon={<Sparkles />}
                      onClick={() => {
                        // Simulate optimization process
                        setSnackbar({ open: true, message: 'å¼€å§‹ä¼˜åŒ–æç¤ºè¯...', severity: 'info' })
                        // Here you would implement the actual optimization logic
                      }}
                      className="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
                    >
                      å¼€å§‹ä¼˜åŒ–
                    </Button>
                  </div>

                  {/* Optimization Tips */}
                  <Alert 
                    severity="info" 
                    icon={<Sparkles className="w-6 h-6" />}
                    className="border border-purple-200 bg-purple-50 mt-6"
                  >
                                      <Typography variant="body1" className="text-purple-800">
                    <strong>è‡ªåŠ¨è°ƒä¼˜æç¤ºè¯ï¼š</strong>
                    ç³»ç»Ÿå°†æ ¹æ®æ‚¨é…ç½®çš„ä¼˜åŒ–æ¨¡å‹ã€è¯„ä¼°æ¨¡å‹å’Œä¼˜åŒ–è½®æ•°ï¼Œè‡ªåŠ¨ä¼˜åŒ–ç³»ç»Ÿæç¤ºè¯ã€‚
                    ä¼˜åŒ–è¿‡ç¨‹å°†ç»“åˆä¸Šä¼ çš„ç”¨ä¾‹é›†æˆ–æ‰‹åŠ¨è¾“å…¥çš„ç¤ºä¾‹å¯¹è¯ï¼Œç”Ÿæˆæ›´ç²¾å‡†çš„æç¤ºè¯é…ç½®ã€‚
                  </Typography>
                  </Alert>
                </Paper>
              </div>
            </div>
          </TabPanel>

          {/* Orchestration Configuration Tab */}
          <TabPanel value={activeTab} index={1}>
            <div className="space-y-8">
              {/* Model Selection */}
              <Accordion defaultExpanded className="shadow-sm border border-gray-200 rounded-xl">
                <AccordionSummary expandIcon={<Settings />} className="px-6">
                  <Typography variant="h6" className="flex items-center text-gray-800 font-semibold">
                    <Zap className="mr-3 w-5 h-5 text-yellow-600" />
                    æ¨¡å‹é€‰æ‹©ä¸é…ç½®
                  </Typography>
                </AccordionSummary>
                <AccordionDetails className="px-6 pb-6">
                  <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <FormControl fullWidth>
                        <Typography variant="subtitle1" className="mb-3 text-gray-700 font-medium">
                          LLMæ¨¡å‹
                        </Typography>
                        <Select
                          value={agentConfig.model}
                          onChange={(e) => setAgentConfig(prev => ({ ...prev, model: e.target.value }))}
                          className="mt-2"
                        >
                          <MenuItem value="gpt-4">GPT-4</MenuItem>
                          <MenuItem value="gpt-3.5-turbo">GPT-3.5 Turbo</MenuItem>
                          <MenuItem value="claude-3">Claude-3</MenuItem>
                          <MenuItem value="gemini-pro">Gemini Pro</MenuItem>
                          <MenuItem value="qwen-plus">Qwen Plus</MenuItem>
                        </Select>
                      </FormControl>

                      <div>
                        <Typography variant="subtitle1" className="mb-3 text-gray-700 font-medium">
                          æ¸©åº¦ (Temperature)
                        </Typography>
                        <TextField
                          fullWidth
                          type="number"
                          value={agentConfig.modelParams.temperature}
                          onChange={(e) => setAgentConfig(prev => ({
                            ...prev,
                            modelParams: { ...prev.modelParams, temperature: parseFloat(e.target.value) }
                          }))}
                          inputProps={{ min: 0, max: 2, step: 0.1 }}
                          helperText="æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§"
                          className="mt-2"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <Typography variant="subtitle1" className="mb-3 text-gray-700 font-medium">
                          æœ€å¤§Tokenæ•°
                        </Typography>
                        <TextField
                          fullWidth
                          type="number"
                          value={agentConfig.modelParams.maxTokens}
                          onChange={(e) => setAgentConfig(prev => ({
                            ...prev,
                            modelParams: { ...prev.modelParams, maxTokens: parseInt(e.target.value) }
                          }))}
                          inputProps={{ min: 1, max: 8000 }}
                          helperText="é™åˆ¶å•æ¬¡å¯¹è¯çš„æœ€å¤§è¾“å‡ºé•¿åº¦"
                          className="mt-2"
                        />
                      </div>

                      <div>
                        <Typography variant="subtitle1" className="mb-3 text-gray-700 font-medium">
                          Top P
                        </Typography>
                        <TextField
                          fullWidth
                          type="number"
                          value={agentConfig.modelParams.topP}
                          onChange={(e) => setAgentConfig(prev => ({
                            ...prev,
                            modelParams: { ...prev.modelParams, topP: parseFloat(e.target.value) }
                          }))}
                          inputProps={{ min: 0, max: 1, step: 0.1 }}
                          helperText="æ§åˆ¶è¯æ±‡é€‰æ‹©çš„å¤šæ ·æ€§"
                          className="mt-2"
                        />
                      </div>
                    </div>
                  </div>
                </AccordionDetails>
              </Accordion>

              {/* Plugin and Workflow Selection */}
              <Accordion className="shadow-sm border border-gray-200 rounded-xl">
                <AccordionSummary expandIcon={<Settings />} className="px-6">
                  <Typography variant="h6" className="flex items-center text-gray-800 font-semibold">
                    <Plug className="mr-3 w-5 h-5 text-green-600" />
                    æ’ä»¶ä¸å·¥ä½œæµ
                  </Typography>
                </AccordionSummary>
                <AccordionDetails className="px-6 pb-6">
                  <div className="space-y-6">
                    <div>
                      <Typography variant="subtitle1" className="mb-4 text-gray-700 font-medium">
                        é€‰æ‹©æ’ä»¶
                      </Typography>
                      <div className="flex flex-wrap gap-3">
                        {['web_search', 'calculator', 'file_reader', 'image_generator', 'code_interpreter'].map((plugin) => (
                          <Chip
                            key={plugin}
                            label={plugin}
                            onClick={() => {
                              const isSelected = agentConfig.plugins.includes(plugin)
                              setAgentConfig(prev => ({
                                ...prev,
                                plugins: isSelected 
                                  ? prev.plugins.filter(p => p !== plugin)
                                  : [...prev.plugins, plugin]
                              }))
                            }}
                            color={agentConfig.plugins.includes(plugin) ? 'primary' : 'default'}
                            variant={agentConfig.plugins.includes(plugin) ? 'filled' : 'outlined'}
                            className="text-sm px-3 py-2"
                          />
                        ))}
                      </div>
                    </div>

                    <div>
                      <Typography variant="subtitle1" className="mb-4 text-gray-700 font-medium">
                        é€‰æ‹©å·¥ä½œæµ
                      </Typography>
                      <div className="flex flex-wrap gap-3">
                        {['customer_service', 'troubleshooting', 'data_analysis', 'content_generation'].map((workflow) => (
                          <Chip
                            key={workflow}
                            label={workflow}
                            onClick={() => {
                              const isSelected = agentConfig.workflows.includes(workflow)
                              setAgentConfig(prev => ({
                                ...prev,
                                workflows: isSelected 
                                  ? prev.workflows.filter(w => w !== workflow)
                                  : [...prev.workflows, workflow]
                              }))
                            }}
                            color={agentConfig.workflows.includes(workflow) ? 'primary' : 'default'}
                            variant={agentConfig.workflows.includes(workflow) ? 'filled' : 'outlined'}
                            className="text-sm px-3 py-2"
                          />
                        ))}
                      </div>
                    </div>
                  </div>
                </AccordionDetails>
              </Accordion>

              {/* Knowledge and Memory */}
              <Accordion className="shadow-sm border border-gray-200 rounded-xl">
                <AccordionSummary expandIcon={<Settings />} className="px-6">
                  <Typography variant="h6" className="flex items-center text-gray-800 font-semibold">
                    <BookOpen className="mr-3 w-5 h-5 text-purple-600" />
                    çŸ¥è¯†ä¸è®°å¿†
                  </Typography>
                </AccordionSummary>
                <AccordionDetails className="px-6 pb-6">
                  <div className="space-y-6">
                    <div>
                      <Typography variant="subtitle1" className="mb-4 text-gray-700 font-medium">
                        çŸ¥è¯†åº“
                      </Typography>
                      <div className="flex flex-wrap gap-3">
                        {['product_manual', 'faq_database', 'company_policies', 'user_guides'].map((knowledge) => (
                          <Chip
                            key={knowledge}
                            label={knowledge}
                            onClick={() => {
                              const isSelected = agentConfig.knowledge.includes(knowledge)
                              setAgentConfig(prev => ({
                                ...prev,
                                knowledge: isSelected 
                                  ? prev.knowledge.filter(k => k !== knowledge)
                                  : [...prev.knowledge, knowledge]
                              }))
                            }}
                            color={agentConfig.knowledge.includes(knowledge) ? 'primary' : 'default'}
                            variant={agentConfig.knowledge.includes(knowledge) ? 'filled' : 'outlined'}
                            className="text-sm px-3 py-2"
                          />
                        ))}
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <FormControlLabel
                        control={
                          <Switch
                            checked={agentConfig.memory.enabled}
                            onChange={(e) => setAgentConfig(prev => ({
                              ...prev,
                              memory: { ...prev.memory, enabled: e.target.checked }
                            }))}
                            color="primary"
                          />
                        }
                        label={
                          <Typography variant="subtitle1" className="text-gray-700 font-medium">
                            å¯ç”¨è®°å¿†åŠŸèƒ½
                          </Typography>
                        }
                      />

                      <FormControl fullWidth>
                        <Typography variant="subtitle1" className="mb-3 text-gray-700 font-medium">
                          è®°å¿†ç±»å‹
                        </Typography>
                        <Select
                          value={agentConfig.memory.type}
                          onChange={(e) => setAgentConfig(prev => ({
                            ...prev,
                            memory: { ...prev.memory, type: e.target.value as any }
                          }))}
                          disabled={!agentConfig.memory.enabled}
                          className="mt-2"
                        >
                          <MenuItem value="conversation">å¯¹è¯è®°å¿†</MenuItem>
                          <MenuItem value="semantic">è¯­ä¹‰è®°å¿†</MenuItem>
                          <MenuItem value="hybrid">æ··åˆè®°å¿†</MenuItem>
                        </Select>
                      </FormControl>
                    </div>
                  </div>
                </AccordionDetails>
              </Accordion>

              {/* Opening Remarks */}
              <Paper elevation={0} className="p-6 border border-gray-200 rounded-xl">
                <Typography variant="h6" className="mb-4 flex items-center text-gray-800 font-semibold">
                  <MessageSquare className="mr-3 w-5 h-5 text-indigo-600" />
                  å¼€åœºç™½è®¾ç½®
                </Typography>
                <TextField
                  fullWidth
                  multiline
                  rows={3}
                  value={agentConfig.openingRemarks}
                  onChange={(e) => setAgentConfig(prev => ({ ...prev, openingRemarks: e.target.value }))}
                  placeholder="è®¾ç½®æ™ºèƒ½ä½“çš„å¼€åœºç™½ï¼Œè®©ç”¨æˆ·äº†è§£å¦‚ä½•å¼€å§‹å¯¹è¯..."
                  helperText="è¿™æ˜¯ç”¨æˆ·å¼€å§‹å¯¹è¯æ—¶æ™ºèƒ½ä½“çš„ç¬¬ä¸€å¥è¯"
                  className="mt-2"
                />
              </Paper>
            </div>
          </TabPanel>

          {/* Preview and Debug Tab */}
          <TabPanel value={activeTab} index={2}>
            <div className="space-y-8">
              {/* Test Input */}
              <Paper elevation={0} className="p-6 border border-gray-200 rounded-xl">
                <Typography variant="h6" className="mb-4 text-gray-800 font-semibold">
                  æµ‹è¯•è¾“å…¥
                </Typography>
                <div className="flex items-center space-x-4">
                  <TextField
                    fullWidth
                    value={testMessage}
                    onChange={(e) => setTestMessage(e.target.value)}
                    placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯æ¥è°ƒè¯•æ™ºèƒ½ä½“..."
                    onKeyPress={(e) => e.key === 'Enter' && handleTest()}
                    className="mt-2"
                  />
                  <Button
                    variant="contained"
                    startIcon={<Play />}
                    onClick={handleTest}
                    disabled={isTesting || !testMessage.trim()}
                    className="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 shadow-lg px-6"
                  >
                    {isTesting ? 'æµ‹è¯•ä¸­...' : 'å‘é€æµ‹è¯•'}
                  </Button>
                </div>
              </Paper>

              {/* Test History */}
              <Paper elevation={0} className="p-6 border border-gray-200 rounded-xl">
                <Typography variant="h6" className="mb-4 text-gray-800 font-semibold">
                  å¯¹è¯å†å²
                </Typography>
                <div className="space-y-4 max-h-96 overflow-y-auto bg-gray-50 p-4 rounded-lg">
                  {agentConfig.testHistory.length === 0 ? (
                    <div className="text-center py-12">
                      <TestTube className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                      <p className="text-gray-500 text-lg">æš‚æ— å¯¹è¯è®°å½•ï¼Œå¼€å§‹æµ‹è¯•ä»¥æŸ¥çœ‹æ•ˆæœ</p>
                    </div>
                  ) : (
                    agentConfig.testHistory.map((msg, index) => (
                      <div
                        key={index}
                        className={`p-4 rounded-lg ${
                          msg.role === 'user' 
                            ? 'bg-blue-100 ml-8 border-l-4 border-blue-500' 
                            : 'bg-green-100 mr-8 border-l-4 border-green-500'
                        }`}
                      >
                        <div className="flex items-center justify-between mb-2">
                          <div className="font-semibold text-sm">
                            {msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– AIåŠ©æ‰‹'}
                          </div>
                          <div className="text-xs text-gray-500">
                            {msg.timestamp.toLocaleTimeString()}
                          </div>
                        </div>
                        <div className="text-gray-800">{msg.content}</div>
                      </div>
                    ))
                  )}
                </div>
              </Paper>

              {/* Debug Information */}
              <Paper elevation={0} className="p-6 border border-gray-200 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50">
                <Typography variant="h6" className="mb-4 text-gray-800 font-semibold">
                  è°ƒè¯•ä¿¡æ¯
                </Typography>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                  <div className="bg-white p-4 rounded-lg border border-blue-200">
                    <strong className="text-blue-800">å½“å‰æ¨¡å‹ï¼š</strong> {agentConfig.model}
                  </div>
                  <div className="bg-white p-4 rounded-lg border border-blue-200">
                    <strong className="text-blue-800">æ¸©åº¦è®¾ç½®ï¼š</strong> {agentConfig.modelParams.temperature}
                  </div>
                  <div className="bg-white p-4 rounded-lg border border-blue-200">
                    <strong className="text-blue-800">å¯ç”¨æ’ä»¶ï¼š</strong> {agentConfig.plugins.join(', ') || 'æ— '}
                  </div>
                  <div className="bg-white p-4 rounded-lg border border-blue-200">
                    <strong className="text-blue-800">è®°å¿†çŠ¶æ€ï¼š</strong> {agentConfig.memory.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                  </div>
                  <div className="bg-white p-4 rounded-lg border border-blue-200">
                    <strong className="text-blue-800">ç¼–è¾‘æ¨¡å¼ï¼š</strong> {agentConfig.editMode === 'ai' ? 'AIè¾…åŠ©' : 'æ‰‹åŠ¨ç¼–è¾‘'}
                  </div>
                  <div className="bg-white p-4 rounded-lg border border-blue-200">
                    <strong className="text-blue-800">å¯¹è¯è½®æ•°ï¼š</strong> {agentConfig.testHistory.length / 2}
                  </div>
                </div>
              </Paper>

              {/* Action Buttons */}
              <div className="flex items-center justify-between pt-6">
                <div className="flex space-x-3">
                  <Button
                    variant="outlined"
                    startIcon={<Upload />}
                    component="label"
                    className="border-gray-300 text-gray-600 hover:border-gray-400"
                  >
                    å¯¼å…¥é…ç½®
                    <input
                      type="file"
                      hidden
                      accept=".json"
                      onChange={handleImport}
                    />
                  </Button>
                  
                  <Button
                    variant="outlined"
                    startIcon={<Download />}
                    onClick={handleExport}
                    className="border-gray-300 text-gray-600 hover:border-gray-400"
                  >
                    å¯¼å‡ºé…ç½®
                  </Button>
                </div>

                <Button
                  variant="outlined"
                  color="error"
                  startIcon={<Trash2 />}
                  onClick={() => {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ™ºèƒ½ä½“å—ï¼Ÿ')) {
                      navigate('/dashboard/agents')
                    }
                  }}
                  className="border-red-300 text-red-600 hover:border-red-400 hover:bg-red-50"
                >
                  åˆ é™¤æ™ºèƒ½ä½“
                </Button>
              </div>
            </div>
          </TabPanel>
        </Card>
      </div>

      <Snackbar
        open={snackbar.open}
        autoHideDuration={6000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
      >
        <Alert 
          onClose={() => setSnackbar({ ...snackbar, open: false })} 
          severity={snackbar.severity}
        >
          {snackbar.message}
        </Alert>
      </Snackbar>
    </div>
  )
}

export default AgentEditorEnhancedPage