import React, { useState, useEffect } from 'react'
import { useNavigate, useLocation } from 'react-router-dom'
import { 
  ArrowLeft, 
  Save, 
  Play, 
  TestTube,
  Copy,
  Download,
  Upload,
  Trash2,
  Brain,
  Settings,
  Eye,
  Sparkles,
  Zap,
  BookOpen,
  MessageSquare,
  Plug
} from 'lucide-react'
import { 
  TextField, 
  Button, 
  Select, 
  MenuItem, 
  FormControl, 
  InputLabel, 
  Switch, 
  FormControlLabel,
  Chip,
  Tabs,
  Tab,
  Box,
  Typography,
  Card,
  Alert,
  Snackbar,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Divider,
} from '@mui/material'

interface TabPanelProps {
  children?: React.ReactNode
  index: number
  value: number
}

interface AgentEntryData {
  editMode: 'manual' | 'ai'
  name: string
  description: string
  icon: string
}

interface AgentConfig {
  name: string
  description: string
  icon: string
  editMode: 'manual' | 'ai'
  
  // System Prompt Configuration
  systemPrompt: string
  autoGeneratedPrompt: string
  promptTuning: {
    role: string
    capabilities: string[]
    behavior: string
    examples: string
  }
  
  // Orchestration Configuration
  model: string
  modelParams: {
    temperature: number
    maxTokens: number
    topP: number
    frequencyPenalty: number
    presencePenalty: number
  }
  plugins: string[]
  workflows: string[]
  triggers: string[]
  knowledge: string[]
  memory: {
    enabled: boolean
    type: 'conversation' | 'semantic' | 'hybrid'
    maxTokens: number
  }
  openingRemarks: string
  
  // Preview and Debug
  testHistory: Array<{ role: 'user' | 'assistant', content: string, timestamp: Date }>
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props

  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`agent-tabpanel-${index}`}
      aria-labelledby={`agent-tab-${index}`}
      {...other}
    >
      {value === index && (
        <Box sx={{ p: 3 }}>
          {children}
        </Box>
      )}
    </div>
  )
}

const AgentEditorEnhancedPage: React.FC = () => {
  const navigate = useNavigate()
  const location = useLocation()
  
  const [activeTab, setActiveTab] = useState(0)
  const [snackbar, setSnackbar] = useState({ open: false, message: '', severity: 'success' as 'success' | 'error' })
  
  // Get entry data from navigation state
  const entryData = location.state?.agentEntryData as AgentEntryData | undefined

  // Agent configuration state
  const [agentConfig, setAgentConfig] = useState<AgentConfig>({
    name: entryData?.name || 'æ™ºèƒ½å®¢æœåŠ©æ‰‹',
    description: entryData?.description || 'ä¸“ä¸šçš„å®¢æˆ·æœåŠ¡æ™ºèƒ½ä½“ï¼Œèƒ½å¤Ÿå¤„ç†å¸¸è§é—®é¢˜å’ŒæŠ•è¯‰',
    icon: entryData?.icon || 'ğŸ¤–',
    editMode: entryData?.editMode || 'manual',
    
    // System Prompt Configuration
    systemPrompt: entryData?.editMode === 'ai' ? 
      `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„${entryData?.name || 'æ™ºèƒ½åŠ©æ‰‹'}ï¼Œ${entryData?.description || ''}ã€‚è¯·å§‹ç»ˆä¿æŒå‹å¥½ã€ä¸“ä¸šçš„æ€åº¦ï¼Œæä¾›å‡†ç¡®ã€æœ‰ç”¨çš„å¸®åŠ©ã€‚` :
      'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æˆ·æœåŠ¡ä»£è¡¨ï¼Œè¯·ç”¨å‹å¥½ã€ä¸“ä¸šçš„æ€åº¦å›ç­”å®¢æˆ·é—®é¢˜ã€‚',
    autoGeneratedPrompt: '',
    promptTuning: {
      role: 'æ™ºèƒ½åŠ©æ‰‹',
      capabilities: ['é—®é¢˜è§£ç­”', 'ä¿¡æ¯æŸ¥è¯¢', 'ä»»åŠ¡ååŠ©'],
      behavior: 'å‹å¥½ã€ä¸“ä¸šã€å‡†ç¡®',
      examples: 'ç”¨æˆ·ï¼šä½ å¥½\nåŠ©æ‰‹ï¼šæ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ'
    },
    
    // Orchestration Configuration
    model: 'gpt-4',
    modelParams: {
      temperature: 0.7,
      maxTokens: 2000,
      topP: 0.9,
      frequencyPenalty: 0.0,
      presencePenalty: 0.0
    },
    plugins: ['web_search', 'calculator', 'file_reader'],
    workflows: ['customer_service', 'troubleshooting'],
    triggers: ['greeting', 'question', 'complaint'],
    knowledge: ['product_manual', 'faq_database', 'company_policies'],
    memory: {
      enabled: true,
      type: 'conversation',
      maxTokens: 1000
    },
    openingRemarks: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
    
    // Preview and Debug
    testHistory: []
  })

  // Test chat state
  const [testMessage, setTestMessage] = useState('')
  const [isTesting, setIsTesting] = useState(false)

  useEffect(() => {
    if (entryData?.editMode === 'ai') {
      // Auto-generate system prompt for AI mode
      const generatedPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„${entryData.name}ï¼Œ${entryData.description}ã€‚

è§’è‰²å®šä¹‰ï¼š
- ä¸»è¦èŒè´£ï¼š${entryData.description}
- è¡Œä¸ºå‡†åˆ™ï¼šå§‹ç»ˆä¿æŒå‹å¥½ã€ä¸“ä¸šã€å‡†ç¡®
- å“åº”é£æ ¼ï¼šæ¸…æ™°ã€æœ‰ç”¨ã€åŠæ—¶

èƒ½åŠ›èŒƒå›´ï¼š
- é—®é¢˜è§£ç­”ï¼šèƒ½å¤Ÿç†è§£å¹¶å›ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜
- ä»»åŠ¡ååŠ©ï¼šå¸®åŠ©ç”¨æˆ·å®Œæˆç›¸å…³ä»»åŠ¡
- ä¿¡æ¯æŸ¥è¯¢ï¼šæä¾›å‡†ç¡®çš„ä¿¡æ¯å’Œå»ºè®®

è¯·æ ¹æ®ä»¥ä¸Šé…ç½®ï¼Œä¸ºç”¨æˆ·æä¾›æœ€å¥½çš„æœåŠ¡ä½“éªŒã€‚`

      setAgentConfig(prev => ({
        ...prev,
        autoGeneratedPrompt: generatedPrompt,
        systemPrompt: generatedPrompt
      }))
    }
  }, [entryData])

  const handleTabChange = (_event: React.SyntheticEvent, newValue: number) => {
    setActiveTab(newValue)
  }

  const handleSave = () => {
    // Simulate saving
    setSnackbar({ open: true, message: 'æ™ºèƒ½ä½“é…ç½®ä¿å­˜æˆåŠŸï¼', severity: 'success' })
  }

  const handleTest = async () => {
    if (!testMessage.trim()) return
    
    setIsTesting(true)
    const userMessage = { 
      role: 'user' as const, 
      content: testMessage,
      timestamp: new Date()
    }
    
    setAgentConfig(prev => ({
      ...prev,
      testHistory: [...prev.testHistory, userMessage]
    }))
    
    // Simulate AI response
    setTimeout(() => {
      const aiResponse = { 
        role: 'assistant' as const, 
        content: `è¿™æ˜¯å¯¹"${testMessage}"çš„æ¨¡æ‹Ÿå›å¤ã€‚åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨é…ç½®çš„LLM APIå¹¶æ ¹æ®ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆå“åº”ã€‚`,
        timestamp: new Date()
      }
      
      setAgentConfig(prev => ({
        ...prev,
        testHistory: [...prev.testHistory, aiResponse]
      }))
      setIsTesting(false)
    }, 1000)
    
    setTestMessage('')
  }

  const handleCopyPrompt = () => {
    navigator.clipboard.writeText(agentConfig.systemPrompt)
    setSnackbar({ open: true, message: 'ç³»ç»Ÿæç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', severity: 'success' })
  }

  const handleExport = () => {
    const dataStr = JSON.stringify(agentConfig, null, 2)
    const dataBlob = new Blob([dataStr], { type: 'application/json' })
    const url = URL.createObjectURL(dataBlob)
    const link = document.createElement('a')
    link.href = url
    link.download = `${agentConfig.name || 'agent'}.json`
    link.click()
    URL.revokeObjectURL(url)
  }

  const handleImport = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      const reader = new FileReader()
      reader.onload = (e) => {
        try {
          const importedConfig = JSON.parse(e.target?.result as string)
          setAgentConfig(importedConfig)
          setSnackbar({ open: true, message: 'æ™ºèƒ½ä½“é…ç½®å¯¼å…¥æˆåŠŸ', severity: 'success' })
        } catch (error) {
          setSnackbar({ open: true, message: 'å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯', severity: 'error' })
        }
      }
      reader.readAsText(file)
    }
  }

  return (
    <div className="space-y-6">
      {/* Page header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-4">
          <Button
            variant="outlined"
            startIcon={<ArrowLeft />}
            onClick={() => navigate('/dashboard/agents')}
          >
            è¿”å›
          </Button>
          <div className="flex items-center space-x-3">
            <span className="text-2xl">{agentConfig.icon}</span>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">
                {agentConfig.name}
              </h1>
              <p className="text-gray-600">
                {agentConfig.description}
              </p>
            </div>
          </div>
        </div>
        
        <div className="flex items-center space-x-3">
          <Button
            variant="outlined"
            startIcon={<TestTube />}
            onClick={() => setActiveTab(2)}
          >
            æµ‹è¯•è°ƒè¯•
          </Button>
          <Button
            variant="contained"
            startIcon={<Save />}
            onClick={handleSave}
          >
            ä¿å­˜é…ç½®
          </Button>
        </div>
      </div>

      {/* Main content */}
      <Card>
        <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
          <Tabs value={activeTab} onChange={handleTabChange} aria-label="æ™ºèƒ½ä½“é…ç½®æ ‡ç­¾é¡µ">
            <Tab 
              label={
                <div className="flex items-center space-x-2">
                  <Brain className="w-4 h-4" />
                  <span>ç³»ç»Ÿæç¤ºè¯é…ç½®</span>
                </div>
              } 
            />
            <Tab 
              label={
                <div className="flex items-center space-x-2">
                  <Settings className="w-4 h-4" />
                  <span>ç¼–æ’é…ç½®</span>
                </div>
              } 
            />
            <Tab 
              label={
                <div className="flex items-center space-x-2">
                  <Eye className="w-4 h-4" />
                  <span>é¢„è§ˆè°ƒè¯•</span>
                </div>
              } 
            />
          </Tabs>
        </Box>

        {/* System Prompt Configuration Tab */}
        <TabPanel value={activeTab} index={0}>
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <Typography variant="h6">ç³»ç»Ÿæç¤ºè¯å¼€å‘</Typography>
              <Button
                size="small"
                startIcon={<Copy />}
                onClick={handleCopyPrompt}
              >
                å¤åˆ¶æç¤ºè¯
              </Button>
            </div>
            
            <TextField
              fullWidth
              multiline
              rows={8}
              label="ç³»ç»Ÿæç¤ºè¯"
              value={agentConfig.systemPrompt}
              onChange={(e) => setAgentConfig(prev => ({ ...prev, systemPrompt: e.target.value }))}
              placeholder="å®šä¹‰æ™ºèƒ½ä½“çš„è§’è‰²ã€èƒ½åŠ›å’Œè¡Œä¸ºå‡†åˆ™..."
            />

            {agentConfig.editMode === 'ai' && (
              <Alert severity="info" icon={<Sparkles />}>
                <Typography variant="body2">
                  <strong>AI è¾…åŠ©ç”Ÿæˆï¼š</strong>
                  ç³»ç»Ÿå·²æ ¹æ®æ‚¨çš„æè¿°è‡ªåŠ¨ç”Ÿæˆäº†ç³»ç»Ÿæç¤ºè¯ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚
                </Typography>
              </Alert>
            )}

            <Divider />

            {/* Prompt Tuning Section */}
            <div>
              <Typography variant="h6" className="mb-4">æç¤ºè¯è°ƒä¼˜</Typography>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <TextField
                  fullWidth
                  label="è§’è‰²å®šä¹‰"
                  value={agentConfig.promptTuning.role}
                  onChange={(e) => setAgentConfig(prev => ({
                    ...prev,
                    promptTuning: { ...prev.promptTuning, role: e.target.value }
                  }))}
                  placeholder="ä¾‹å¦‚ï¼šæ™ºèƒ½å®¢æœä»£è¡¨"
                />

                <TextField
                  fullWidth
                  label="è¡Œä¸ºç‰¹å¾"
                  value={agentConfig.promptTuning.behavior}
                  onChange={(e) => setAgentConfig(prev => ({
                    ...prev,
                    promptTuning: { ...prev.promptTuning, behavior: e.target.value }
                  }))}
                  placeholder="ä¾‹å¦‚ï¼šå‹å¥½ã€ä¸“ä¸šã€å‡†ç¡®"
                />
              </div>

              <TextField
                fullWidth
                multiline
                rows={3}
                label="ç¤ºä¾‹å¯¹è¯"
                value={agentConfig.promptTuning.examples}
                onChange={(e) => setAgentConfig(prev => ({
                  ...prev,
                  promptTuning: { ...prev.promptTuning, examples: e.target.value }
                }))}
                placeholder="æä¾›ä¸€äº›ç¤ºä¾‹å¯¹è¯æ¥æŒ‡å¯¼æ™ºèƒ½ä½“çš„å“åº”æ¨¡å¼..."
                className="mt-4"
              />
            </div>
          </div>
        </TabPanel>

        {/* Orchestration Configuration Tab */}
        <TabPanel value={activeTab} index={1}>
          <div className="space-y-6">
            {/* Model Selection */}
            <Accordion defaultExpanded>
              <AccordionSummary expandIcon={<Settings />}>
                <Typography variant="h6" className="flex items-center">
                  <Zap className="mr-2" />
                  æ¨¡å‹é€‰æ‹©ä¸é…ç½®
                </Typography>
              </AccordionSummary>
              <AccordionDetails>
                <div className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormControl fullWidth>
                      <InputLabel>LLMæ¨¡å‹</InputLabel>
                      <Select
                        value={agentConfig.model}
                        label="LLMæ¨¡å‹"
                        onChange={(e) => setAgentConfig(prev => ({ ...prev, model: e.target.value }))}
                      >
                        <MenuItem value="gpt-4">GPT-4</MenuItem>
                        <MenuItem value="gpt-3.5-turbo">GPT-3.5 Turbo</MenuItem>
                        <MenuItem value="claude-3">Claude-3</MenuItem>
                        <MenuItem value="gemini-pro">Gemini Pro</MenuItem>
                        <MenuItem value="qwen-plus">Qwen Plus</MenuItem>
                      </Select>
                    </FormControl>

                    <TextField
                      fullWidth
                      type="number"
                      label="æ¸©åº¦ (Temperature)"
                      value={agentConfig.modelParams.temperature}
                      onChange={(e) => setAgentConfig(prev => ({
                        ...prev,
                        modelParams: { ...prev.modelParams, temperature: parseFloat(e.target.value) }
                      }))}
                      inputProps={{ min: 0, max: 2, step: 0.1 }}
                      helperText="æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§"
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <TextField
                      fullWidth
                      type="number"
                      label="æœ€å¤§Tokenæ•°"
                      value={agentConfig.modelParams.maxTokens}
                      onChange={(e) => setAgentConfig(prev => ({
                        ...prev,
                        modelParams: { ...prev.modelParams, maxTokens: parseInt(e.target.value) }
                      }))}
                      inputProps={{ min: 1, max: 8000 }}
                      helperText="é™åˆ¶å•æ¬¡å¯¹è¯çš„æœ€å¤§è¾“å‡ºé•¿åº¦"
                    />

                    <TextField
                      fullWidth
                      type="number"
                      label="Top P"
                      value={agentConfig.modelParams.topP}
                      onChange={(e) => setAgentConfig(prev => ({
                        ...prev,
                        modelParams: { ...prev.modelParams, topP: parseFloat(e.target.value) }
                      }))}
                      inputProps={{ min: 0, max: 1, step: 0.1 }}
                      helperText="æ§åˆ¶è¯æ±‡é€‰æ‹©çš„å¤šæ ·æ€§"
                    />
                  </div>
                </div>
              </AccordionDetails>
            </Accordion>

            {/* Plugin and Workflow Selection */}
            <Accordion>
              <AccordionSummary expandIcon={<Settings />}>
                <Typography variant="h6" className="flex items-center">
                  <Plug className="mr-2" />
                  æ’ä»¶ä¸å·¥ä½œæµ
                </Typography>
              </AccordionSummary>
              <AccordionDetails>
                <div className="space-y-4">
                  <div>
                    <Typography variant="subtitle1" className="mb-2">é€‰æ‹©æ’ä»¶</Typography>
                    <div className="flex flex-wrap gap-2">
                      {['web_search', 'calculator', 'file_reader', 'image_generator', 'code_interpreter'].map((plugin) => (
                        <Chip
                          key={plugin}
                          label={plugin}
                          onClick={() => {
                            const isSelected = agentConfig.plugins.includes(plugin)
                            setAgentConfig(prev => ({
                              ...prev,
                              plugins: isSelected 
                                ? prev.plugins.filter(p => p !== plugin)
                                : [...prev.plugins, plugin]
                            }))
                          }}
                          color={agentConfig.plugins.includes(plugin) ? 'primary' : 'default'}
                          variant={agentConfig.plugins.includes(plugin) ? 'filled' : 'outlined'}
                        />
                      ))}
                    </div>
                  </div>

                  <div>
                    <Typography variant="subtitle1" className="mb-2">é€‰æ‹©å·¥ä½œæµ</Typography>
                    <div className="flex flex-wrap gap-2">
                      {['customer_service', 'troubleshooting', 'data_analysis', 'content_generation'].map((workflow) => (
                        <Chip
                          key={workflow}
                          label={workflow}
                          onClick={() => {
                            const isSelected = agentConfig.workflows.includes(workflow)
                            setAgentConfig(prev => ({
                              ...prev,
                              workflows: isSelected 
                                ? prev.workflows.filter(w => w !== workflow)
                                : [...prev.workflows, workflow]
                            }))
                          }}
                          color={agentConfig.workflows.includes(workflow) ? 'primary' : 'default'}
                          variant={agentConfig.workflows.includes(workflow) ? 'filled' : 'outlined'}
                        />
                      ))}
                    </div>
                  </div>
                </div>
              </AccordionDetails>
            </Accordion>

            {/* Knowledge and Memory */}
            <Accordion>
              <AccordionSummary expandIcon={<Settings />}>
                <Typography variant="h6" className="flex items-center">
                  <BookOpen className="mr-2" />
                  çŸ¥è¯†ä¸è®°å¿†
                </Typography>
              </AccordionSummary>
              <AccordionDetails>
                <div className="space-y-4">
                  <div>
                    <Typography variant="subtitle1" className="mb-2">çŸ¥è¯†åº“</Typography>
                    <div className="flex flex-wrap gap-2">
                      {['product_manual', 'faq_database', 'company_policies', 'user_guides'].map((knowledge) => (
                        <Chip
                          key={knowledge}
                          label={knowledge}
                          onClick={() => {
                            const isSelected = agentConfig.knowledge.includes(knowledge)
                            setAgentConfig(prev => ({
                              ...prev,
                              knowledge: isSelected 
                                ? prev.knowledge.filter(k => k !== knowledge)
                                : [...prev.knowledge, knowledge]
                            }))
                          }}
                          color={agentConfig.knowledge.includes(knowledge) ? 'primary' : 'default'}
                          variant={agentConfig.knowledge.includes(knowledge) ? 'filled' : 'outlined'}
                        />
                      ))}
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormControlLabel
                      control={
                        <Switch
                          checked={agentConfig.memory.enabled}
                          onChange={(e) => setAgentConfig(prev => ({
                            ...prev,
                            memory: { ...prev.memory, enabled: e.target.checked }
                          }))}
                        />
                      }
                      label="å¯ç”¨è®°å¿†åŠŸèƒ½"
                    />

                    <FormControl fullWidth>
                      <InputLabel>è®°å¿†ç±»å‹</InputLabel>
                      <Select
                        value={agentConfig.memory.type}
                        label="è®°å¿†ç±»å‹"
                        onChange={(e) => setAgentConfig(prev => ({
                          ...prev,
                          memory: { ...prev.memory, type: e.target.value as any }
                        }))}
                        disabled={!agentConfig.memory.enabled}
                      >
                        <MenuItem value="conversation">å¯¹è¯è®°å¿†</MenuItem>
                        <MenuItem value="semantic">è¯­ä¹‰è®°å¿†</MenuItem>
                        <MenuItem value="hybrid">æ··åˆè®°å¿†</MenuItem>
                      </Select>
                    </FormControl>
                  </div>
                </div>
              </AccordionDetails>
            </Accordion>

            {/* Opening Remarks */}
            <div>
              <Typography variant="h6" className="mb-4 flex items-center">
                <MessageSquare className="mr-2" />
                å¼€åœºç™½è®¾ç½®
              </Typography>
              <TextField
                fullWidth
                multiline
                rows={3}
                label="å¼€åœºç™½"
                value={agentConfig.openingRemarks}
                onChange={(e) => setAgentConfig(prev => ({ ...prev, openingRemarks: e.target.value }))}
                placeholder="è®¾ç½®æ™ºèƒ½ä½“çš„å¼€åœºç™½ï¼Œè®©ç”¨æˆ·äº†è§£å¦‚ä½•å¼€å§‹å¯¹è¯..."
                helperText="è¿™æ˜¯ç”¨æˆ·å¼€å§‹å¯¹è¯æ—¶æ™ºèƒ½ä½“çš„ç¬¬ä¸€å¥è¯"
              />
            </div>
          </div>
        </TabPanel>

        {/* Preview and Debug Tab */}
        <TabPanel value={activeTab} index={2}>
          <div className="space-y-6">
            {/* Test Input */}
            <div className="flex items-center space-x-4">
              <TextField
                fullWidth
                label="æµ‹è¯•æ¶ˆæ¯"
                value={testMessage}
                onChange={(e) => setTestMessage(e.target.value)}
                placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯æ¥è°ƒè¯•æ™ºèƒ½ä½“..."
                onKeyPress={(e) => e.key === 'Enter' && handleTest()}
              />
              <Button
                variant="contained"
                startIcon={<Play />}
                onClick={handleTest}
                disabled={isTesting || !testMessage.trim()}
              >
                {isTesting ? 'æµ‹è¯•ä¸­...' : 'å‘é€æµ‹è¯•'}
              </Button>
            </div>

            {/* Test History */}
            <div className="border rounded-lg p-4 bg-gray-50">
              <Typography variant="h6" className="mb-4">å¯¹è¯å†å²</Typography>
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {agentConfig.testHistory.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">æš‚æ— å¯¹è¯è®°å½•ï¼Œå¼€å§‹æµ‹è¯•ä»¥æŸ¥çœ‹æ•ˆæœ</p>
                ) : (
                  agentConfig.testHistory.map((msg, index) => (
                    <div
                      key={index}
                      className={`p-3 rounded-lg ${
                        msg.role === 'user' 
                          ? 'bg-blue-100 ml-8' 
                          : 'bg-green-100 mr-8'
                      }`}
                    >
                      <div className="flex items-center justify-between mb-1">
                        <div className="font-medium text-sm">
                          {msg.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹'}
                        </div>
                        <div className="text-xs text-gray-500">
                          {msg.timestamp.toLocaleTimeString()}
                        </div>
                      </div>
                      <div>{msg.content}</div>
                    </div>
                  ))
                )}
              </div>
            </div>

            {/* Debug Information */}
            <div className="border rounded-lg p-4 bg-blue-50">
              <Typography variant="h6" className="mb-4">è°ƒè¯•ä¿¡æ¯</Typography>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                  <strong>å½“å‰æ¨¡å‹ï¼š</strong> {agentConfig.model}
                </div>
                <div>
                  <strong>æ¸©åº¦è®¾ç½®ï¼š</strong> {agentConfig.modelParams.temperature}
                </div>
                <div>
                  <strong>å¯ç”¨æ’ä»¶ï¼š</strong> {agentConfig.plugins.join(', ') || 'æ— '}
                </div>
                <div>
                  <strong>è®°å¿†çŠ¶æ€ï¼š</strong> {agentConfig.memory.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                </div>
                <div>
                  <strong>ç¼–è¾‘æ¨¡å¼ï¼š</strong> {agentConfig.editMode === 'ai' ? 'AIè¾…åŠ©' : 'æ‰‹åŠ¨ç¼–è¾‘'}
                </div>
                <div>
                  <strong>å¯¹è¯è½®æ•°ï¼š</strong> {agentConfig.testHistory.length / 2}
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex items-center justify-between">
              <div className="flex space-x-2">
                <Button
                  variant="outlined"
                  startIcon={<Upload />}
                  component="label"
                >
                  å¯¼å…¥é…ç½®
                  <input
                    type="file"
                    hidden
                    accept=".json"
                    onChange={handleImport}
                  />
                </Button>
                
                <Button
                  variant="outlined"
                  startIcon={<Download />}
                  onClick={handleExport}
                >
                  å¯¼å‡ºé…ç½®
                </Button>
              </div>

              <Button
                variant="outlined"
                color="error"
                startIcon={<Trash2 />}
                onClick={() => {
                  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ™ºèƒ½ä½“å—ï¼Ÿ')) {
                    navigate('/dashboard/agents')
                  }
                }}
              >
                åˆ é™¤æ™ºèƒ½ä½“
              </Button>
            </div>
          </div>
        </TabPanel>
      </Card>

      <Snackbar
        open={snackbar.open}
        autoHideDuration={6000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
      >
        <Alert 
          onClose={() => setSnackbar({ ...snackbar, open: false })} 
          severity={snackbar.severity}
        >
          {snackbar.message}
        </Alert>
      </Snackbar>
    </div>
  )
}

export default AgentEditorEnhancedPage